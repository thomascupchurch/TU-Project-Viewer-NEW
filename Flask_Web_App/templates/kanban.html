{% extends "base.html" %}
{% block content %}
<style>
    .kanban-col { min-width: 300px; background: #f8f9fa; border-radius: 8px; padding: 1rem; margin-right: 1rem; }
    .kanban-card { background: #fff; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 1rem; padding: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.03); cursor: grab; }
    .kanban-list { min-height: 60px; }
    .kanban-placeholder { color: #bbb; text-align: center; font-style: italic; padding: 1.5rem 0; }
</style>
<div class="container-fluid my-4">
    <h1 class="mb-4">Project Kanban Board</h1>
    <div class="d-flex flex-row" id="kanban-board">
        {% for status in ['Not Started', 'In Progress', 'Completed'] %}
        <div class="kanban-col flex-grow-1" data-status="{{ status }}">
            <h4>{{ status }}</h4>
            <div class="kanban-list" id="kanban-{{ status|replace(' ', '-') }}">
            {% set found = false %}
            {% for task in tasks if task.status == status %}
                {% set found = true %}
                <div class="kanban-card" data-task-id="{{ task.id }}" style="border-left: 6px solid {{ task.color if task.color else '#4287f5' }};">
                    <strong>{{ task.name }}</strong> <span class="badge bg-secondary">#{{ task.id }}</span><br>
                    <span class="text-muted">{{ task.start }} ({{ task.duration }}d)</span><br>
                    <span>Responsible: {{ task.responsible }}</span><br>
                                        <span>Status: {{ task.status }} | Progress: {{ task.percent_complete }}%</span>
                                        <div class="progress my-1" style="height: 16px; background: var(--secondary-color);">
                                            <div class="progress-bar" role="progressbar" style="width: {{ task.percent_complete|default(0) }}%; background: var(--primary-color);" aria-valuenow="{{ task.percent_complete|default(0) }}" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                    {% if task.attachments %}
                    <span>Attachments:
                        {% for att in task.attachments %}
                            <a href="/static/uploads/{{ att }}" target="_blank">{{ att }}</a>{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </span><br>
                    {% endif %}
                    {% if task.pdf_page %}
                    <span>PDF Page: {{ task.pdf_page }}</span><br>
                    {% endif %}
                    {% if task.parent %}
                    <span class="text-info">Sub-item of #{{ task.parent }}</span><br>
                    {% endif %}
                </div>
            {% endfor %}
            {% if not found %}
                <div class="kanban-placeholder">Drop tasks here</div>
            {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
// Enable drag-and-drop for each kanban list
['Not Started', 'In Progress', 'Completed'].forEach(function(status) {
    var el = document.getElementById('kanban-' + status.replace(/ /g, '-'));
    if (el) {
        new Sortable(el, {
            group: 'kanban',
            animation: 150,
            onAdd: function (evt) {
                var card = evt.item;
                var taskId = card.getAttribute('data-task-id');
                var newStatus = card.closest('.kanban-col').getAttribute('data-status');
                // Send AJAX to update status
                fetch('/update_task_status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: taskId, status: newStatus })
                }).then(r => r.json()).then(data => {
                    if (!data.success) alert('Failed to update task status');
                });
            }
        });
    }
});
</script>
{% endblock %}
