{% extends "base.html" %}
{% block content %}
<div class="container my-4">
    <h1 class="mb-4">Project Calendar</h1>
    <a href="/calendar_export_ics" class="btn btn-outline-info mb-3">Download for Outlook (.ics)</a>
    <div id="calendar"></div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded fired');
    var calendarEl = document.getElementById('calendar');
    if (!calendarEl) {
        console.error('No #calendar element found!');
        return;
    }
    console.log('Found #calendar element:', calendarEl);
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 700,
        events: function(fetchInfo, successCallback, failureCallback) {
            console.log('Fetching events from /tasks_json...');
            fetch('/tasks_json')
                .then(response => response.json())
                .then(function(tasks) {
                    console.log('Loaded tasks:', tasks);
                    const events = tasks.map(function(task) {
                        return {
                            id: task.id,
                            title: task.name + (task.percent_complete ? ' (' + task.percent_complete + '%)' : ''),
                            start: task.start,
                            end: task.start,
                            allDay: true,
                            extendedProps: task
                        };
                    });
                    console.log('Mapped events:', events);
                    successCallback(events);
                })
                .catch(function(err) {
                    console.error('Error fetching /tasks_json:', err);
                    failureCallback(err);
                });
        },
        eventClick: function(info) {
            const t = info.event.extendedProps;
            let details = `Task: ${info.event.title}\nStart: ${info.event.startStr}`;
            if (t.responsible) details += `\nResponsible: ${t.responsible}`;
            if (t.status) details += `\nStatus: ${t.status}`;
            if (t.percent_complete) details += `\nProgress: ${t.percent_complete}%`;
            if (t.attachments && t.attachments.length > 0) details += `\nAttachments: ${t.attachments.join(', ')}`;
            if (t.pdf_page) details += `\nPDF Page: ${t.pdf_page}`;
            if (t.parent) details += `\nSub-item of #${t.parent}`;
            alert(details);
        }
    });
    try {
        calendar.render();
        console.log('calendar.render() called');
    } catch (e) {
        console.error('Error rendering calendar:', e);
    }
});
</script>
{% endblock %}
