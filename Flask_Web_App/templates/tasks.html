{% extends "base.html" %}
{% block content %}
    {% if alert_message %}
    <div class="alert alert-danger" role="alert">
        {{ alert_message }}
    </div>
    {% endif %}
<div class="container my-4">
    <h2 class="mb-4">Items List & Creation</h2>
    <div class="form-check form-switch mb-3">
        <input class="form-check-input" type="checkbox" id="hideExternalTasksToggle">
    <label class="form-check-label" for="hideExternalTasksToggle">Hide External Items & Milestones</label>
    </div>
    <form method="post" enctype="multipart/form-data" class="row g-3 mb-4">
        <div class="col-md-3">
            <select class="form-select" name="phase">
                <option value="">Select Phase</option>
                {% if phases %}
                    {% for phase in phases %}
                        <option value="{{ phase.name }}">{{ phase.name }}</option>
                    {% endfor %}
                {% endif %}
            </select>
        </div>
        <div class="col-12 mb-2">
            <a href="{{ url_for('phases_page') }}" class="btn btn-outline-secondary btn-sm">Manage Phases</a>
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control" name="share_with" placeholder="Share with (comma-separated usernames)">
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control" name="name" placeholder="Item Name" required>
        </div>
        <div class="col-md-2">
            <input type="date" class="form-control" name="start" placeholder="Start Date">
        </div>
        <div class="col-md-2">
            <input type="text" class="form-control" name="responsible" placeholder="Responsible">
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control" name="duration" placeholder="Duration (days)">
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control" name="percent_complete" placeholder="% Complete" min="0" max="100">
        </div>
        <div class="col-md-1 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Add Item</button>
        </div>
        <div class="col-12">
            <a class="btn btn-link p-0" data-bs-toggle="collapse" href="#advancedFields" role="button" aria-expanded="false" aria-controls="advancedFields">
                Show Advanced Fields
            </a>
        </div>
        <div class="collapse" id="advancedFields">
            <div class="card card-body mt-3">
                <div class="row g-3">
                    <div class="col-md-3">
                        <input type="text" class="form-control" name="depends_on" placeholder="Depends On (Item Name)">
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" name="resources" placeholder="Resources">
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" name="notes" placeholder="Notes">
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" name="pdf_page" placeholder="PDF Page">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" name="pdf_file">
                            <option value="">PDF File</option>
                            {% if pdf_files %}
                                {% for f in pdf_files %}
                                    <option value="{{ f }}">{{ f }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" name="parent" placeholder="Parent Item Name">
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" name="milestone" placeholder="Milestone">
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" name="status" placeholder="Status (e.g. Not Started, In Progress, Completed)">
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control" name="document_links" placeholder="Document Links (comma separated)">
                    </div>
                    <div class="col-md-6">
                        <input type="file" class="form-control" name="attachments" multiple>
                    </div>
                    <div class="col-md-3 form-check">
                        <input class="form-check-input" type="checkbox" name="external_task" id="external_task_add">
                        <label class="form-check-label" for="external_task_add">External Item</label>
                    </div>
                    <div class="col-md-3 form-check">
                        <input class="form-check-input" type="checkbox" name="external_milestone" id="external_milestone_add">
                        <label class="form-check-label" for="external_milestone_add">External Milestone</label>
                    </div>
                </div>
            </div>
        </div>
    </form>
        <table class="table table-bordered table-hover">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Start</th>
                    <th>Responsible</th>
                    <th>Duration</th>
                    <th>Status</th>
                    <th>Progress</th>
                    <th>Milestone</th>
                    <th>PDF File</th>
                    <th>PDF Pg</th>
                    <th>Ext</th>
                    <th>Parent</th>
                    <th>Depends On</th>
                    <th>Attachments</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% set phase_tasks = {} %}
                {% for task in tasks %}
                    {% set phase = task.phase or 'No Phase' %}
                    {% if phase_tasks[phase] is not defined %}
                        {% set _ = phase_tasks.update({phase: []}) %}
                    {% endif %}
                    {% set _ = phase_tasks[phase].append(task) %}
                {% endfor %}
                {% for phase, phase_group in phase_tasks.items() %}
                    <tr class="table-secondary">
                        <td colspan="12"><strong>Phase: {{ phase }}</strong></td>
                    </tr>
                    {% for task in phase_group %}
                    <tr>
                        <td>{{ task.id }}</td>
                        <td>{{ task.name }}</td>
                        <td>{{ task.start }}</td>
                        <td>{{ task.responsible }}</td>
                        <td>{{ task.duration }}</td>
                        <td>{{ task.status }}</td>
                        <td>
                            <div class="progress" style="height: 20px; background: var(--secondary-color);">
                                <div class="progress-bar" role="progressbar" style="width: {{ task.percent_complete|default(0) }}%; background: var(--primary-color);" aria-valuenow="{{ task.percent_complete|default(0) }}" aria-valuemin="0" aria-valuemax="100">
                                    {{ task.percent_complete|default(0) }}%
                                </div>
                            </div>
                        </td>
                        <td>{{ task.milestone }}</td>
                        <td>{{ task.pdf_file }}</td>
                        <td>{{ task.pdf_page }}</td>
                        <td>
                            {% if task.external_item or task.external_task %}<span class="badge bg-danger">Item</span>{% endif %}
                            {% if task.external_milestone %}<span class="badge bg-danger">Milestone</span>{% endif %}
                        </td>
                        <td>{{ task.parent }}</td>
                        <td>{{ task.depends_on }}</td>
                        <td>
                            {% if task.attachments and task.attachments|length > 0 %}
                                {% for fname in task.attachments %}
                                    <a href="/static/uploads/{{ fname|urlencode }}" target="_blank">{{ fname }}</a>{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">None</span>
                            {% endif %}
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-secondary edit-task-btn" data-task-idx="{{ loop.index0 }}">Edit</button>
                            <button type="button" class="btn btn-sm btn-outline-danger delete-task-btn ms-1" data-task-idx="{{ loop.index0 }}">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>

    <!-- Edit Item Modal -->
        <div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="edit-task-form" method="post">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editTaskModalLabel">Edit Item</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" name="edit_idx" id="edit_idx_modal">
                            <div class="mb-2">
                                <label class="form-label">Item Name</label>
                                <input type="text" class="form-control" name="name" id="edit_name" required>
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" name="start" id="edit_start">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Responsible</label>
                                <input type="text" class="form-control" name="responsible" id="edit_responsible">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Duration (days)</label>
                                <input type="number" class="form-control" name="duration" id="edit_duration">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">% Complete</label>
                                <input type="number" class="form-control" name="percent_complete" id="edit_percent_complete" min="0" max="100">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Status</label>
                                <input type="text" class="form-control" name="status" id="edit_status">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Milestone</label>
                                <input type="text" class="form-control" name="milestone" id="edit_milestone">
                            </div>
                            <div class="mb-2 form-check">
                                <input class="form-check-input" type="checkbox" name="external_task" id="edit_external_task">
                                <label class="form-check-label" for="edit_external_task">External Item</label>
                            </div>
                            <div class="mb-2 form-check">
                                <input class="form-check-input" type="checkbox" name="external_milestone" id="edit_external_milestone">
                                <label class="form-check-label" for="edit_external_milestone">External Milestone</label>
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Parent</label>
                                <input type="text" class="form-control" name="parent" id="edit_parent">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Depends On</label>
                                <input type="text" class="form-control" name="depends_on" id="edit_depends_on">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Resources</label>
                                <input type="text" class="form-control" name="resources" id="edit_resources">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Notes</label>
                                <input type="text" class="form-control" name="notes" id="edit_notes">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">PDF Page</label>
                                <input type="text" class="form-control" name="pdf_page" id="edit_pdf_page">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">PDF File</label>
                                <select class="form-select" name="pdf_file" id="edit_pdf_file">
                                    <option value="">(none)</option>
                                    {% if pdf_files %}
                                        {% for f in pdf_files %}
                                            <option value="{{ f }}">{{ f }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Document Links (comma separated)</label>
                                <input type="text" class="form-control" name="document_links" id="edit_document_links">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Attachments</label>
                                <div id="edit_attachments_list"></div>
                                <input type="file" class="form-control mt-2" name="attachments" id="edit_attachments" multiple>
                                <small class="text-muted">Upload new files or remove existing ones below.</small>
                                <div id="edit_attachments_links" class="mt-2"></div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
{% block scripts %}
{{ super() }}
<script>
// Modal edit logic, delete, and attachment editing
document.addEventListener('DOMContentLoaded', function() {
    // Get items data from a JS variable injected by Jinja
    const itemsData = {{ tasks|tojson|safe }}; // data for edit modal
    const hideToggle = document.getElementById('hideExternalTasksToggle');
    function applyExternalFilter() {
        const hide = hideToggle.checked;
        // Iterate rows (skip phase header rows with class table-secondary)
        document.querySelectorAll('table tbody tr').forEach(function(row) {
            if (row.classList.contains('table-secondary')) return; // phase header
            const hasExternal = row.querySelector('.badge.bg-danger') !== null;
            if (hide && hasExternal) {
                row.style.display = 'none';
            } else {
                row.style.display = '';
            }
        });
        // Hide phase header if all subsequent task rows (until next header) hidden
        const headers = Array.from(document.querySelectorAll('table tbody tr.table-secondary'));
        headers.forEach(function(header) {
            let sibling = header.nextElementSibling;
            let anyVisible = false;
            while (sibling && !sibling.classList.contains('table-secondary')) {
                if (sibling.style.display !== 'none') { anyVisible = true; break; }
                sibling = sibling.nextElementSibling;
            }
            header.style.display = anyVisible ? '' : (hide ? 'none' : '');
        });
    }
    hideToggle.addEventListener('change', applyExternalFilter);
    // Persist preference via localStorage
    const savedPref = localStorage.getItem('hideExternalTasks');
    if (savedPref === '1') { hideToggle.checked = true; }
    hideToggle.addEventListener('change', () => {
        localStorage.setItem('hideExternalTasks', hideToggle.checked ? '1' : '0');
        applyExternalFilter();
    });
    applyExternalFilter();
    // Edit button logic
    document.querySelectorAll('.edit-task-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const idx = btn.getAttribute('data-task-idx');
            const row = btn.closest('tr');
            const cells = row.querySelectorAll('td');
            document.getElementById('edit_idx_modal').value = idx;
            document.getElementById('edit_name').value = cells[1].innerText.trim();
            document.getElementById('edit_start').value = cells[2].innerText.trim();
            document.getElementById('edit_responsible').value = cells[3].innerText.trim();
            document.getElementById('edit_duration').value = cells[4].innerText.trim();
            document.getElementById('edit_status').value = cells[5].innerText.trim();
            // Progress bar cell: extract percent
            let percentText = cells[6].innerText.trim();
            let percentValue = 0;
            if (percentText.endsWith('%')) {
                percentValue = parseInt(percentText.replace('%','').trim()) || 0;
            } else {
                percentValue = parseInt(percentText) || 0;
            }
            document.getElementById('edit_percent_complete').value = percentValue;
            document.getElementById('edit_milestone').value = cells[7].innerText.trim();
            const pdfFileVal = cells[8].innerText.trim();
            const pdfPgVal = cells[9].innerText.trim();
            document.getElementById('edit_parent').value = cells[11].innerText.trim();
            document.getElementById('edit_depends_on').value = cells[12].innerText.trim();
            // Advanced fields (resources, notes, pdf_page, document_links)
            document.getElementById('edit_resources').value = itemsData[idx].resources || '';
            document.getElementById('edit_notes').value = itemsData[idx].notes || '';
            document.getElementById('edit_pdf_page').value = pdfPgVal || itemsData[idx].pdf_page || '';
            const editPdfFileSel = document.getElementById('edit_pdf_file');
            if(editPdfFileSel){
                editPdfFileSel.value = pdfFileVal || itemsData[idx].pdf_file || '';
            }
            document.getElementById('edit_document_links').value = (itemsData[idx].document_links || []).join(', ');
            document.getElementById('edit_external_task').checked = !!(itemsData[idx].external_item || itemsData[idx].external_task);
            document.getElementById('edit_external_milestone').checked = !!itemsData[idx].external_milestone;
            // Attachments
            const attachments = itemsData[idx].attachments || [];
            const listDiv = document.getElementById('edit_attachments_list');
            listDiv.innerHTML = '';
            if (attachments.length > 0) {
                attachments.forEach(function(fname) {
                    const el = document.createElement('div');
                    el.className = 'd-flex align-items-center mb-1';
                    el.innerHTML = `<span class='me-2'>${fname}</span> <button type='button' class='btn btn-sm btn-outline-danger btn-delete-attachment' data-fname='${fname}' data-task-idx='${idx}'>Remove</button>`;
                    listDiv.appendChild(el);
                });
            } else {
                listDiv.innerHTML = '<span class="text-muted">No attachments</span>';
            }
            // Download links for attachments
            const linksDiv = document.getElementById('edit_attachments_links');
            linksDiv.innerHTML = '';
            if (attachments.length > 0) {
                attachments.forEach(function(fname) {
                    const a = document.createElement('a');
                    a.href = '/static/uploads/' + encodeURIComponent(fname);
                    a.target = '_blank';
                    a.className = 'd-block';
                    a.innerText = 'Download: ' + fname;
                    linksDiv.appendChild(a);
                });
            }
            var editModal = new bootstrap.Modal(document.getElementById('editTaskModal'));
            editModal.show();
        });
    });
    // On modal form submit, submit as POST with edit_idx
    document.getElementById('edit-task-form').addEventListener('submit', function(e) {
        // Allow file upload
        this.enctype = 'multipart/form-data';
    });
    // Delete task logic
    document.querySelectorAll('.delete-task-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const idx = btn.getAttribute('data-task-idx');
            if (confirm('Are you sure you want to delete this task?')) {
                fetch('/delete_task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task_idx: idx })
                }).then(r => r.json()).then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Delete failed: ' + (data.error || 'Unknown error'));
                    }
                });
            }
        });
    });
    // Delete attachment logic (in modal)
    document.getElementById('edit_attachments_list').addEventListener('click', function(e) {
        if (e.target.classList.contains('btn-delete-attachment')) {
            const fname = e.target.getAttribute('data-fname');
            const idx = e.target.getAttribute('data-task-idx');
            if (confirm('Remove attachment ' + fname + '?')) {
                fetch('/delete_attachment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task_idx: idx, filename: fname })
                }).then(r => r.json()).then(data => {
                    if (data.success) {
                        e.target.parentElement.remove();
                    } else {
                        alert('Failed to remove attachment: ' + (data.error || 'Unknown error'));
                    }
                });
            }
        }
    });
});
</script>
{% endblock %}
</div>
{% endblock %}